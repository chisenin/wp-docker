name: 镜像构建工作流

permissions:
  contents: write
  actions: write
  packages: write

on:
  repository_dispatch:
    types: [build-images]
  workflow_dispatch:
    # 允许手动触发
    inputs:
      modules:
        description: '要构建的模块（base,php,nginx,mariadb,redis），多个用逗号分隔'
        required: true
        default: 'base,php,nginx,mariadb,redis'
        type: string
      rebuild_type:
        description: '重构类型（full/partial/test）'
        required: false
        default: 'full'
        type: string
      test_mode:
        description: '测试模式（true/false），测试模式下构建所有功能模块'
        required: false
        default: 'false'
        type: string
      php_version:
        description: 'PHP版本'
        required: false
        default: '8.3'
        type: string
      nginx_version:
        description: 'Nginx版本'
        required: false
        default: '1.27.2'
        type: string
      mariadb_version:
        description: 'MariaDB版本'
        required: false
        default: '10.11'
        type: string
      redis_version:
        description: 'Redis版本'
        required: false
        default: '7.2'
        type: string
      alpine_version:
        description: 'Alpine版本'
        required: false
        default: '3.20'
        type: string

jobs:
  # 准备环境和设置构建参数
  setup:
    runs-on: ubuntu-latest
    outputs:
      php_version: ${{ steps.prepare-params.outputs.php_version }}
      nginx_version: ${{ steps.prepare-params.outputs.nginx_version }}
      mariadb_version: ${{ steps.prepare-params.outputs.mariadb_version }}
      redis_version: ${{ steps.prepare-params.outputs.redis_version }}
      alpine_version: ${{ steps.prepare-params.outputs.alpine_version }}
      modules: ${{ steps.prepare-params.outputs.modules }}
      rebuild_type: ${{ steps.prepare-params.outputs.rebuild_type }}
      test_mode: ${{ steps.prepare-params.outputs.test_mode }}
      is_auto_deploy: ${{ steps.check-trigger.outputs.is_auto_deploy }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 检查触发来源
        id: check-trigger
        run: |
          # 检查是否来自自动部署（repository_dispatch）
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "is_auto_deploy=true" >> $GITHUB_OUTPUT
            echo "触发来源: 自动部署"
          else
            echo "is_auto_deploy=false" >> $GITHUB_OUTPUT
            echo "触发来源: 手动触发"
          fi
          
          # 检查是否包含auto_deploy.sh变更
          if [ -f "wp-docker/deploy/scripts/auto_deploy.sh" ]; then
            echo "has_auto_deploy_script=true" >> $GITHUB_OUTPUT
          else
            echo "has_auto_deploy_script=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 准备构建参数
        id: prepare-params
        run: |
          # 从client_payload或workflow_dispatch输入获取参数
          if [ -n "${{ github.event.client_payload.modules }}" ]; then
            MODULES="${{ github.event.client_payload.modules }}"
          else
            MODULES="${{ github.event.inputs.modules }}"
          fi
          
          if [ -n "${{ github.event.client_payload.rebuild_type }}" ]; then
            REBUILD_TYPE="${{ github.event.client_payload.rebuild_type }}"
          else
            REBUILD_TYPE="${{ github.event.inputs.rebuild_type }}"
          fi
          
          # 获取测试模式
          if [ -n "${{ github.event.client_payload.test_mode }}" ]; then
            TEST_MODE="${{ github.event.client_payload.test_mode }}"
          else
            TEST_MODE="${{ github.event.inputs.test_mode }}"
          fi
          
          if [ -n "${{ github.event.client_payload.php_version }}" ]; then
            PHP_VERSION="${{ github.event.client_payload.php_version }}"
          else
            PHP_VERSION="${{ github.event.inputs.php_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.nginx_version }}" ]; then
            NGINX_VERSION="${{ github.event.client_payload.nginx_version }}"
          else
            NGINX_VERSION="${{ github.event.inputs.nginx_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.alpine_version }}" ]; then
            ALPINE_VERSION="${{ github.event.client_payload.alpine_version }}"
          else
            ALPINE_VERSION="${{ github.event.inputs.alpine_version }}"
          fi
          
          # 获取MariaDB版本
          if [ -n "${{ github.event.client_payload.mariadb_version }}" ]; then
            MARIADB_VERSION="${{ github.event.client_payload.mariadb_version }}"
          else
            MARIADB_VERSION="${{ github.event.inputs.mariadb_version }}"
          fi
          
          # 获取Redis版本
          if [ -n "${{ github.event.client_payload.redis_version }}" ]; then
            REDIS_VERSION="${{ github.event.client_payload.redis_version }}"
          else
            REDIS_VERSION="${{ github.event.inputs.redis_version }}"
          fi
          
          # 测试模式下强制构建所有功能模块
          if [ "$TEST_MODE" = "true" ] || [ "$REBUILD_TYPE" = "test" ]; then
            echo "⚠️ 测试模式：构建所有功能模块"
            REBUILD_TYPE="test"
            MODULES="base,php,nginx,mariadb,redis"
          fi
          
          echo "构建参数："
          echo "- 模块: $MODULES"
          echo "- 重构类型: $REBUILD_TYPE"
          echo "- 测试模式: $TEST_MODE"
          echo "- PHP版本: $PHP_VERSION"
          echo "- Nginx版本: $NGINX_VERSION"
          echo "- MariaDB版本: $MARIADB_VERSION"
          echo "- Redis版本: $REDIS_VERSION"
          echo "- Alpine版本: $ALPINE_VERSION"
          
          # 设置输出
          echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
          echo "mariadb_version=$MARIADB_VERSION" >> $GITHUB_OUTPUT
          echo "redis_version=$REDIS_VERSION" >> $GITHUB_OUTPUT
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "rebuild_type=$REBUILD_TYPE" >> $GITHUB_OUTPUT
          echo "test_mode=$TEST_MODE" >> $GITHUB_OUTPUT
          
          # 保存版本信息
          mkdir -p build/Dockerfiles/php build/Dockerfiles/nginx build/Dockerfiles/mariadb build/Dockerfiles/redis build/Dockerfiles/base
          echo "$PHP_VERSION" > build/Dockerfiles/php/php_version.txt
          echo "$NGINX_VERSION" > build/Dockerfiles/nginx/nginx_version.txt
          echo "$MARIADB_VERSION" > build/Dockerfiles/mariadb/mariadb_version.txt
          echo "$REDIS_VERSION" > build/Dockerfiles/redis/redis_version.txt
          echo "$ALPINE_VERSION" > build/Dockerfiles/base/alpine_version.txt

  # 构建基础镜像
  build-base-image:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送基础镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/base
          file: ./build/Dockerfiles/base/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            ALPINE_VERSION=${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-base:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}

  # 检查功能模块是否需要重构
  check-modules:
    needs: [setup, build-base-image]
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    outputs:
      rebuild_php: ${{ steps.module-check.outputs.rebuild_php }}
      rebuild_nginx: ${{ steps.module-check.outputs.rebuild_nginx }}
      rebuild_mariadb: ${{ steps.module-check.outputs.rebuild_mariadb }}
      rebuild_redis: ${{ steps.module-check.outputs.rebuild_redis }}
      changed_modules: ${{ steps.module-check.outputs.changed_modules }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 检查模块是否需要重构
        id: module-check
        run: |
          # 默认为不需要重构
          REBUILD_PHP="false"
          REBUILD_NGINX="false"
          REBUILD_MARIADB="false"
          REBUILD_REDIS="false"
          CHANGED_MODULES=""
          
          # 全量重构模式或测试模式下所有模块都需要重构
          if [ "${{ needs.setup.outputs.rebuild_type }}" = "full" ] || [ "${{ needs.setup.outputs.rebuild_type }}" = "test" ]; then
            REBUILD_PHP="true"
            REBUILD_NGINX="true"
            REBUILD_MARIADB="true"
            REBUILD_REDIS="true"
            CHANGED_MODULES="php,nginx,mariadb,redis"
          else
            # 检查模块特定文件是否有变更
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "php"; then
              REBUILD_PHP="true"
              CHANGED_MODULES="${CHANGED_MODULES},php"
            fi
            
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "nginx"; then
              REBUILD_NGINX="true"
              CHANGED_MODULES="${CHANGED_MODULES},nginx"
            fi
            
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "mariadb"; then
              REBUILD_MARIADB="true"
              CHANGED_MODULES="${CHANGED_MODULES},mariadb"
            fi
            
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "redis"; then
              REBUILD_REDIS="true"
              CHANGED_MODULES="${CHANGED_MODULES},redis"
            fi
          fi
          
          # 移除开头的逗号
          CHANGED_MODULES=$(echo "$CHANGED_MODULES" | sed 's/^,//')
          
          echo "需要重构的模块: $CHANGED_MODULES"
          echo "rebuild_php=$REBUILD_PHP" >> $GITHUB_OUTPUT
          echo "rebuild_nginx=$REBUILD_NGINX" >> $GITHUB_OUTPUT
          echo "rebuild_mariadb=$REBUILD_MARIADB" >> $GITHUB_OUTPUT
          echo "rebuild_redis=$REBUILD_REDIS" >> $GITHUB_OUTPUT
          echo "changed_modules=$CHANGED_MODULES" >> $GITHUB_OUTPUT
          
          # 如果没有需要重构的功能模块但有基础镜像重构，设置为所有模块都需要重构
          if [ -z "$CHANGED_MODULES" ] && (echo "${{ needs.setup.outputs.modules }}" | grep -q "base" || [ "${{ needs.setup.outputs.rebuild_type }}" = "full" ]); then
            echo "⚠️ 基础镜像变更，所有功能模块都需要重构"
            echo "rebuild_php=true" >> $GITHUB_OUTPUT
            echo "rebuild_nginx=true" >> $GITHUB_OUTPUT
            echo "rebuild_mariadb=true" >> $GITHUB_OUTPUT
            echo "rebuild_redis=true" >> $GITHUB_OUTPUT
            echo "changed_modules=php,nginx,mariadb,redis" >> $GITHUB_OUTPUT
          fi
  
  # 构建PHP镜像
  build-php-image:
    needs: [setup, build-base-image, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_php == 'true' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送PHP镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/php
          file: ./build/Dockerfiles/php/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            PHP_VERSION=${{ needs.setup.outputs.php_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}-${{ github.sha }}

  # 测试PHP镜像
  test-php-image:
    needs: build-php-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行PHP镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -v
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -m | grep -E 'curl|gd|mbstring|mysqli|pdo_mysql|redis|zip'
          
          # 验证WordPress所需的PHP扩展是否已安装
          EXTENSIONS=("curl" "gd" "mbstring" "mysqli" "pdo_mysql" "redis" "zip" "imagick")
          for ext in "${EXTENSIONS[@]}"; do
            if docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -m | grep -q "$ext"; then
              echo "✅ PHP扩展 $ext 已安装"
            else
              echo "❌ PHP扩展 $ext 未安装"
              exit 1
            fi
          done

  # 构建Nginx镜像
  build-nginx-image:
    needs: [setup, build-base-image, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_nginx == 'true' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送Nginx镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/nginx
          file: ./build/Dockerfiles/nginx/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            NGINX_VERSION=${{ needs.setup.outputs.nginx_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}-${{ github.sha }}

  # 测试Nginx镜像
  test-nginx-image:
    needs: build-nginx-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行Nginx镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -v
          
          # 验证Nginx配置是否正确
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -t
          
          # 验证是否包含WordPress所需的配置
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -T | grep -q "php-fpm"
          if [ $? -eq 0 ]; then
            echo "✅ WordPress Nginx配置已正确包含"
          else
            echo "❌ WordPress Nginx配置未找到"
            exit 1
          fi

  # 构建MariaDB镜像
  build-mariadb-image:
    needs: [setup, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_mariadb == 'true' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送MariaDB镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/mariadb
          file: ./build/Dockerfiles/mariadb/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            MARIADB_VERSION=${{ needs.setup.outputs.mariadb_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}-${{ github.sha }}

  # 测试MariaDB镜像
  test-mariadb-image:
    needs: build-mariadb-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行MariaDB镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:latest
          
          # 运行简单的测试命令
          docker run --rm --entrypoint=mysql ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:latest --version
          
          # 验证MariaDB配置
          echo "✅ MariaDB镜像测试完成"

  # 构建Redis镜像
  build-redis-image:
    needs: [setup, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_redis == 'true' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送Redis镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/redis
          file: ./build/Dockerfiles/redis/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            REDIS_VERSION=${{ needs.setup.outputs.redis_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}-${{ github.sha }}

  # 测试Redis镜像
  test-redis-image:
    needs: build-redis-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行Redis镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:latest redis-server --version
          
          # 验证Redis配置
          echo "✅ Redis镜像测试完成"

  # 创建GitHub Release
  create-release:
    needs: [setup, check-modules, test-php-image, test-nginx-image, test-mariadb-image, test-redis-image]
    runs-on: ubuntu-latest
    if: ${{ (success() || always()) && needs.setup.outputs.rebuild_type != 'test' && needs.check-modules.outputs.changed_modules != '' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置日期变量
        id: set_date
        run: |
          echo "TODAY=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: 创建GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TIMESTAMP }}
          release_name: 镜像更新 - ${{ env.TODAY }}
          body: |
            ## 构建信息
            - 构建模块: ${{ needs.setup.outputs.modules }}
            - 实际重构模块: ${{ needs.check-modules.outputs.changed_modules || '无' }}
            - 重构类型: ${{ needs.setup.outputs.rebuild_type }}
            - 自动部署: ${{ needs.setup.outputs.is_auto_deploy }}
            
            ## 版本信息
            - PHP版本: ${{ needs.setup.outputs.php_version }}
            - Nginx版本: ${{ needs.setup.outputs.nginx_version }}
            - MariaDB版本: ${{ needs.setup.outputs.mariadb_version }}
            - Redis版本: ${{ needs.setup.outputs.redis_version }}
            - Alpine版本: ${{ needs.setup.outputs.alpine_version }}
            
            ## 变更详情
            - 基础镜像变更: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' }}
            - 功能模块变更: ${{ needs.check-modules.outputs.changed_modules != '' }}
          draft: false
          prerelease: false
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置日期变量
        id: set_date
        run: |
          echo "TODAY=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: 创建GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TIMESTAMP }}
          release_name: 镜像更新 - ${{ env.TODAY }}
          body: |
            ## 镜像更新详情
            - 构建模块: ${{ needs.setup.outputs.modules }}
            - 重构类型: ${{ needs.setup.outputs.rebuild_type }}
            - PHP版本: ${{ needs.setup.outputs.php_version }}
            - Nginx版本: ${{ needs.setup.outputs.nginx_version }}
            - MariaDB版本: ${{ needs.setup.outputs.mariadb_version }}
            - Redis版本: ${{ needs.setup.outputs.redis_version }}
            - Alpine版本: ${{ needs.setup.outputs.alpine_version }}
          draft: false
          prerelease: false

  # 脚本变更快速发布
  script-release:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ needs.setup.outputs.is_auto_deploy == 'true' && !contains(needs.setup.outputs.modules, 'base') && needs.setup.outputs.rebuild_type != 'full' && needs.setup.outputs.rebuild_type != 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 设置日期变量
        id: set_date
        run: |
          echo "TODAY=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
      
      - name: 创建GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: script-${{ env.TIMESTAMP }}
          release_name: 脚本更新 - ${{ env.TODAY }}
          body: |
            ## 脚本更新
            - 更新了 `wp-docker/deploy/scripts/auto_deploy.sh`
            - 无需重构镜像，仅脚本更新
          draft: false
          prerelease: false
      
      - name: 通知完成
        run: |
          echo "✅ 脚本更新快速发布完成"

  # 清理和总结
  cleanup:
    needs: [setup, check-modules, test-php-image, test-nginx-image, test-mariadb-image, test-redis-image, create-release, script-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 清理
        run: |
          # 清理构建过程中的临时文件
          echo "清理构建环境..."
      
      - name: 总结
        run: |
          echo "✅ 镜像构建工作流执行完成"
          echo "构建参数："
            echo "- 构建模块: ${{ needs.setup.outputs.modules }}"
            echo "- 实际重构模块: ${{ needs.check-modules.outputs.changed_modules || '无' }}"
            echo "- 重构类型: ${{ needs.setup.outputs.rebuild_type }}"
            echo "- 测试模式: ${{ needs.setup.outputs.test_mode }}"
            echo "- 自动部署: ${{ needs.setup.outputs.is_auto_deploy }}"
            
            echo "\n版本信息："
            echo "- PHP版本: ${{ needs.setup.outputs.php_version }}"
            echo "- Nginx版本: ${{ needs.setup.outputs.nginx_version }}"
            echo "- MariaDB版本: ${{ needs.setup.outputs.mariadb_version }}"
            echo "- Redis版本: ${{ needs.setup.outputs.redis_version }}"
            echo "- Alpine版本: ${{ needs.setup.outputs.alpine_version }}"
            
            echo "\n发布信息："
            if [ "${{ needs.setup.outputs.rebuild_type }}" != "test" ]; then
              if [ "${{ needs.script-release.result }}" = "success" ]; then
                echo "✅ 脚本更新快速发布已完成"
              elif [ "${{ needs.create-release.result }}" = "success" ]; then
                echo "✅ GitHub Release已创建"
              else
                echo "⚠️ 未创建Release（可能因为没有需要重构的模块）"
              fi
            fi