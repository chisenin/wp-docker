# æ­¤å·¥ä½œæµç”¨äºæ„å»ºå’Œæ¨é€Dockeré•œåƒåˆ°Docker Hub
name: é•œåƒæ„å»ºå·¥ä½œæµ

permissions:
  contents: write
  actions: write
  packages: write

on:
  repository_dispatch:
    types: [build-images]
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      modules:
        description: 'è¦æ„å»ºçš„æ¨¡å—ï¼ˆbase,php,nginx,mariadb,redisï¼‰ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”'
        required: true
        default: 'base,php,nginx,mariadb,redis'
        type: string
      rebuild_type:
        description: 'é‡æ„ç±»å‹ï¼ˆfull/partial/testï¼‰'
        required: false
        default: 'full'
        type: string
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆtrue/falseï¼‰ï¼Œæµ‹è¯•æ¨¡å¼ä¸‹æ„å»ºæ‰€æœ‰åŠŸèƒ½æ¨¡å—'
        required: false
        default: 'false'
        type: string
      php_version:
        description: 'PHPç‰ˆæœ¬'
        required: false
        default: '8.3'
        type: string
      nginx_version:
        description: 'Nginxç‰ˆæœ¬'
        required: false
        default: '1.27.2'
        type: string
      mariadb_version:
        description: 'MariaDBç‰ˆæœ¬'
        required: false
        default: '10.11'
        type: string
      redis_version:
        description: 'Redisç‰ˆæœ¬'
        required: false
        default: '7.2'
        type: string
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'
        type: string

jobs:
  # å‡†å¤‡ç¯å¢ƒå’Œè®¾ç½®æ„å»ºå‚æ•°
  setup:
    runs-on: ubuntu-latest
    outputs:
      php_version: ${{ steps.prepare-params.outputs.php_version }}
      nginx_version: ${{ steps.prepare-params.outputs.nginx_version }}
      mariadb_version: ${{ steps.prepare-params.outputs.mariadb_version }}
      redis_version: ${{ steps.prepare-params.outputs.redis_version }}
      alpine_version: ${{ steps.prepare-params.outputs.alpine_version }}
      modules: ${{ steps.prepare-params.outputs.modules }}
      rebuild_type: ${{ steps.prepare-params.outputs.rebuild_type }}
      test_mode: ${{ steps.prepare-params.outputs.test_mode }}
      is_auto_deploy: ${{ steps.check-trigger.outputs.is_auto_deploy }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥è§¦å‘æ¥æº
        id: check-trigger
        run: |
          # æ£€æŸ¥æ˜¯å¦æ¥è‡ªè‡ªåŠ¨éƒ¨ç½²ï¼ˆrepository_dispatchï¼‰
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "is_auto_deploy=true" >> $GITHUB_OUTPUT
            echo "è§¦å‘æ¥æº: è‡ªåŠ¨éƒ¨ç½²"
          else
            echo "is_auto_deploy=false" >> $GITHUB_OUTPUT
            echo "è§¦å‘æ¥æº: æ‰‹åŠ¨è§¦å‘"
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«auto_deploy.shå˜æ›´
          if [ -f "wp-docker/deploy/scripts/auto_deploy.sh" ]; then
            echo "has_auto_deploy_script=true" >> $GITHUB_OUTPUT
          else
            echo "has_auto_deploy_script=false" >> $GITHUB_OUTPUT
          fi
      
      - name: å‡†å¤‡æ„å»ºå‚æ•°
        id: prepare-params
        run: |
          # ä»client_payloadæˆ–workflow_dispatchè¾“å…¥è·å–å‚æ•°
          if [ -n "${{ github.event.client_payload.modules }}" ]; then
            MODULES="${{ github.event.client_payload.modules }}"
          else
            MODULES="${{ github.event.inputs.modules }}"
          fi
          
          if [ -n "${{ github.event.client_payload.rebuild_type }}" ]; then
            REBUILD_TYPE="${{ github.event.client_payload.rebuild_type }}"
          else
            REBUILD_TYPE="${{ github.event.inputs.rebuild_type }}"
          fi
          
          # è·å–æµ‹è¯•æ¨¡å¼
          if [ -n "${{ github.event.client_payload.test_mode }}" ]; then
            TEST_MODE="${{ github.event.client_payload.test_mode }}"
          else
            TEST_MODE="${{ github.event.inputs.test_mode }}"
          fi
          
          if [ -n "${{ github.event.client_payload.php_version }}" ]; then
            PHP_VERSION="${{ github.event.client_payload.php_version }}"
          else
            PHP_VERSION="${{ github.event.inputs.php_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.nginx_version }}" ]; then
            NGINX_VERSION="${{ github.event.client_payload.nginx_version }}"
          else
            NGINX_VERSION="${{ github.event.inputs.nginx_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.alpine_version }}" ]; then
            ALPINE_VERSION="${{ github.event.client_payload.alpine_version }}"
          else
            ALPINE_VERSION="${{ github.event.inputs.alpine_version }}"
          fi
          
          # è·å–MariaDBç‰ˆæœ¬
          if [ -n "${{ github.event.client_payload.mariadb_version }}" ]; then
            MARIADB_VERSION="${{ github.event.client_payload.mariadb_version }}"
          else
            MARIADB_VERSION="${{ github.event.inputs.mariadb_version }}"
          fi
          
          # è·å–Redisç‰ˆæœ¬
          if [ -n "${{ github.event.client_payload.redis_version }}" ]; then
            REDIS_VERSION="${{ github.event.client_payload.redis_version }}"
          else
            REDIS_VERSION="${{ github.event.inputs.redis_version }}"
          fi
          
          # æµ‹è¯•æ¨¡å¼ä¸‹å¼ºåˆ¶æ„å»ºæ‰€æœ‰åŠŸèƒ½æ¨¡å—
          if [ "$TEST_MODE" = "true" ] || [ "$REBUILD_TYPE" = "test" ]; then
            echo "âš ï¸ æµ‹è¯•æ¨¡å¼ï¼šæ„å»ºæ‰€æœ‰åŠŸèƒ½æ¨¡å—"
            REBUILD_TYPE="test"
            MODULES="base,php,nginx,mariadb,redis"
          fi
          
          echo "æ„å»ºå‚æ•°ï¼š"
          echo "- æ¨¡å—: $MODULES"
          echo "- é‡æ„ç±»å‹: $REBUILD_TYPE"
          echo "- æµ‹è¯•æ¨¡å¼: $TEST_MODE"
          echo "- PHPç‰ˆæœ¬: $PHP_VERSION"
          echo "- Nginxç‰ˆæœ¬: $NGINX_VERSION"
          echo "- MariaDBç‰ˆæœ¬: $MARIADB_VERSION"
          echo "- Redisç‰ˆæœ¬: $REDIS_VERSION"
          echo "- Alpineç‰ˆæœ¬: $ALPINE_VERSION"
          
          # è®¾ç½®è¾“å‡º
          echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
          echo "mariadb_version=$MARIADB_VERSION" >> $GITHUB_OUTPUT
          echo "redis_version=$REDIS_VERSION" >> $GITHUB_OUTPUT
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "rebuild_type=$REBUILD_TYPE" >> $GITHUB_OUTPUT
          echo "test_mode=$TEST_MODE" >> $GITHUB_OUTPUT
          
          # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
          mkdir -p build/Dockerfiles/php build/Dockerfiles/nginx build/Dockerfiles/mariadb build/Dockerfiles/redis build/Dockerfiles/base
          echo "$PHP_VERSION" > build/Dockerfiles/php/php_version.txt
          echo "$NGINX_VERSION" > build/Dockerfiles/nginx/nginx_version.txt
          echo "$MARIADB_VERSION" > build/Dockerfiles/mariadb/mariadb_version.txt
          echo "$REDIS_VERSION" > build/Dockerfiles/redis/redis_version.txt
          echo "$ALPINE_VERSION" > build/Dockerfiles/base/alpine_version.txt

  # æ„å»ºåŸºç¡€é•œåƒ
  build-base-image:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ£€æŸ¥Docker Hubå‡­è¯
        if: github.event_name != 'pull_request'
        run: |
          echo "æ£€æŸ¥DOCKERHUB_USERNAMEå¯†é’¥æ˜¯å¦å­˜åœ¨: ${{ secrets.DOCKERHUB_USERNAME != '' }}"
          echo "DOCKERHUB_USERNAMEé•¿åº¦: ${{ length(secrets.DOCKERHUB_USERNAME) }}"
          # æ³¨æ„ï¼šæˆ‘ä»¬ä¸æ‰“å°DOCKERHUB_TOKENçš„å…·ä½“å†…å®¹ï¼Œåªæ£€æŸ¥å…¶æ˜¯å¦å­˜åœ¨
          echo "DOCKERHUB_TOKENå¯†é’¥æ˜¯å¦å­˜åœ¨: ${{ secrets.DOCKERHUB_TOKEN != '' }}"

      - name: ç™»å½•åˆ°Docker Hub
        if: github.event_name != 'pull_request'  # é¿å…åœ¨PRæ—¶å°è¯•ç™»å½•
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true
        continue-on-error: true

      - name: æ£€æŸ¥æ–‡ä»¶è·¯å¾„
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ£€æŸ¥æ„å»ºä¸Šä¸‹æ–‡æ˜¯å¦å­˜åœ¨:"
          ls -la ./build/Dockerfiles/base/ 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "Dockerfileå†…å®¹é¢„è§ˆ:"
          cat ./build/Dockerfiles/base/Dockerfile 2>/dev/null || echo "Dockerfileä¸å­˜åœ¨"

      - name: æ„å»ºå¹¶æ¨é€åŸºç¡€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/base
          file: ./build/Dockerfiles/base/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            ALPINE_VERSION=${{ needs.setup.outputs.alpine_version }}
          tags:
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:latest
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

  # æ£€æŸ¥åŠŸèƒ½æ¨¡å—æ˜¯å¦éœ€è¦é‡æ„
  check-modules:
    needs: [setup, build-base-image]
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    outputs:
      rebuild_php: ${{ steps.module-check.outputs.rebuild_php }}
      rebuild_nginx: ${{ steps.module-check.outputs.rebuild_nginx }}
      rebuild_mariadb: ${{ steps.module-check.outputs.rebuild_mariadb }}
      rebuild_redis: ${{ steps.module-check.outputs.rebuild_redis }}
      changed_modules: ${{ steps.module-check.outputs.changed_modules }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: æ£€æŸ¥æ¨¡å—æ˜¯å¦éœ€è¦é‡æ„
        id: module-check
        run: |
          # é»˜è®¤ä¸ºä¸éœ€è¦é‡æ„
          REBUILD_PHP="false"
          REBUILD_NGINX="false"
          REBUILD_MARIADB="false"
          REBUILD_REDIS="false"
          CHANGED_MODULES=""
          
          # å…¨é‡é‡æ„æ¨¡å¼æˆ–æµ‹è¯•æ¨¡å¼ä¸‹æ‰€æœ‰æ¨¡å—éƒ½éœ€è¦é‡æ„
          if [ "${{ needs.setup.outputs.rebuild_type }}" = "full" ] || [ "${{ needs.setup.outputs.rebuild_type }}" = "test" ]; then
            REBUILD_PHP="true"
            REBUILD_NGINX="true"
            REBUILD_MARIADB="true"
            REBUILD_REDIS="true"
            CHANGED_MODULES="php,nginx,mariadb,redis"
          else
            # æ£€æŸ¥æ¨¡å—ç‰¹å®šæ–‡ä»¶æ˜¯å¦æœ‰å˜æ›´
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "php"; then
              REBUILD_PHP="true"
              CHANGED_MODULES="${CHANGED_MODULES},php"
            fi
            
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "nginx"; then
              REBUILD_NGINX="true"
              CHANGED_MODULES="${CHANGED_MODULES},nginx"
            fi
            
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "mariadb"; then
              REBUILD_MARIADB="true"
              CHANGED_MODULES="${CHANGED_MODULES},mariadb"
            fi
            
            if echo "${{ needs.setup.outputs.modules }}" | grep -q "redis"; then
              REBUILD_REDIS="true"
              CHANGED_MODULES="${CHANGED_MODULES},redis"
            fi
          fi
          
          # ç§»é™¤å¼€å¤´çš„é€—å·
          CHANGED_MODULES=$(echo "$CHANGED_MODULES" | sed 's/^,//')
          
          echo "éœ€è¦é‡æ„çš„æ¨¡å—: $CHANGED_MODULES"
          echo "rebuild_php=$REBUILD_PHP" >> $GITHUB_OUTPUT
          echo "rebuild_nginx=$REBUILD_NGINX" >> $GITHUB_OUTPUT
          echo "rebuild_mariadb=$REBUILD_MARIADB" >> $GITHUB_OUTPUT
          echo "rebuild_redis=$REBUILD_REDIS" >> $GITHUB_OUTPUT
          echo "changed_modules=$CHANGED_MODULES" >> $GITHUB_OUTPUT
          
          # å¦‚æœæ²¡æœ‰éœ€è¦é‡æ„çš„åŠŸèƒ½æ¨¡å—ä½†æœ‰åŸºç¡€é•œåƒé‡æ„ï¼Œè®¾ç½®ä¸ºæ‰€æœ‰æ¨¡å—éƒ½éœ€è¦é‡æ„
          if [ -z "$CHANGED_MODULES" ] && (echo "${{ needs.setup.outputs.modules }}" | grep -q "base" || [ "${{ needs.setup.outputs.rebuild_type }}" = "full" ]); then
            echo "âš ï¸ åŸºç¡€é•œåƒå˜æ›´ï¼Œæ‰€æœ‰åŠŸèƒ½æ¨¡å—éƒ½éœ€è¦é‡æ„"
            echo "rebuild_php=true" >> $GITHUB_OUTPUT
            echo "rebuild_nginx=true" >> $GITHUB_OUTPUT
            echo "rebuild_mariadb=true" >> $GITHUB_OUTPUT
            echo "rebuild_redis=true" >> $GITHUB_OUTPUT
            echo "changed_modules=php,nginx,mariadb,redis" >> $GITHUB_OUTPUT
          fi
  
  # æ„å»ºPHPé•œåƒ
  build-php-image:
    needs: [setup, build-base-image, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_php == 'true' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°Docker Hub
        if: github.event_name != 'pull_request'  # é¿å…åœ¨PRæ—¶å°è¯•ç™»å½•
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: æ„å»ºå¹¶æ¨é€PHPé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/php
          file: ./build/Dockerfiles/php/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            PHP_VERSION=${{ needs.setup.outputs.php_version }}
            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:latest
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}-${{ github.sha }}

  # æµ‹è¯•PHPé•œåƒ
  test-php-image:
    needs: build-php-image
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒPHPé•œåƒæµ‹è¯•
        run: |
          # æ‹‰å–æ„å»ºçš„é•œåƒ
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:latest
          
          # è¿è¡Œç®€å•çš„æµ‹è¯•å‘½ä»¤
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:latest php -v
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:latest php -m | grep -E 'curl|gd|mbstring|mysqli|pdo_mysql|redis|zip'
          
          # éªŒè¯WordPressæ‰€éœ€çš„PHPæ‰©å±•æ˜¯å¦å·²å®‰è£…
          EXTENSIONS=("curl" "gd" "mbstring" "mysqli" "pdo_mysql" "redis" "zip" "imagick")
          for ext in "${EXTENSIONS[@]}"; do
            if docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:latest php -m | grep -q "$ext"; then
              echo "âœ… PHPæ‰©å±• $ext å·²å®‰è£…"
            else
              echo "âŒ PHPæ‰©å±• $ext æœªå®‰è£…"
              exit 1
            fi
          done

  # æ„å»ºNginxé•œåƒ
  build-nginx-image:
    needs: [setup, build-base-image, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_nginx == 'true' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°Docker Hub
        if: github.event_name != 'pull_request'  # é¿å…åœ¨PRæ—¶å°è¯•ç™»å½•
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: æ„å»ºå¹¶æ¨é€Nginxé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/nginx
          file: ./build/Dockerfiles/nginx/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            NGINX_VERSION=${{ needs.setup.outputs.nginx_version }}
            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:latest
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}-${{ github.sha }}

  # æµ‹è¯•Nginxé•œåƒ
  test-nginx-image:
    needs: build-nginx-image
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒNginxé•œåƒæµ‹è¯•
        run: |
          # æ‹‰å–æ„å»ºçš„é•œåƒ
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:latest
          
          # è¿è¡Œç®€å•çš„æµ‹è¯•å‘½ä»¤
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:latest nginx -v
          
          # éªŒè¯Nginxé…ç½®æ˜¯å¦æ­£ç¡®
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:latest nginx -t
          
          # éªŒè¯æ˜¯å¦åŒ…å«WordPressæ‰€éœ€çš„é…ç½®
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:latest nginx -T | grep -q "php-fpm"
          if [ $? -eq 0 ]; then
            echo "âœ… WordPress Nginxé…ç½®å·²æ­£ç¡®åŒ…å«"
          else
            echo "âŒ WordPress Nginxé…ç½®æœªæ‰¾åˆ°"
            exit 1
          fi

  # æ„å»ºMariaDBé•œåƒ
  build-mariadb-image:
    needs: [setup, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_mariadb == 'true' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°Docker Hub
        if: github.event_name != 'pull_request'  # é¿å…åœ¨PRæ—¶å°è¯•ç™»å½•
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: æ„å»ºå¹¶æ¨é€MariaDBé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/mariadb
          file: ./build/Dockerfiles/mariadb/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            MARIADB_VERSION=${{ needs.setup.outputs.mariadb_version }}
            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:latest
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}-${{ github.sha }}

  # æµ‹è¯•MariaDBé•œåƒ
  test-mariadb-image:
    needs: build-mariadb-image
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒMariaDBé•œåƒæµ‹è¯•
        run: |
          # æ‹‰å–æ„å»ºçš„é•œåƒ
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:latest
          
          # è¿è¡Œç®€å•çš„æµ‹è¯•å‘½ä»¤
          docker run --rm --entrypoint=mysql ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:latest --version
          
          # éªŒè¯MariaDBé…ç½®
          echo "âœ… MariaDBé•œåƒæµ‹è¯•å®Œæˆ"

  # æ„å»ºRedisé•œåƒ
  build-redis-image:
    needs: [setup, check-modules]
    runs-on: ubuntu-latest
    if: ${{ needs.check-modules.outputs.rebuild_redis == 'true' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°Docker Hub
        if: github.event_name != 'pull_request'  # é¿å…åœ¨PRæ—¶å°è¯•ç™»å½•
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: æ„å»ºå¹¶æ¨é€Redisé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/redis
          file: ./build/Dockerfiles/redis/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            REDIS_VERSION=${{ needs.setup.outputs.redis_version }}
            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:latest
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}
            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}-${{ github.sha }}

  # æµ‹è¯•Redisé•œåƒ
  test-redis-image:
    needs: build-redis-image
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒRedisé•œåƒæµ‹è¯•
        run: |
          # æ‹‰å–æ„å»ºçš„é•œåƒ
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:latest
          
          # è¿è¡Œç®€å•çš„æµ‹è¯•å‘½ä»¤
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:latest redis-server --version
          
          # éªŒè¯Redisé…ç½®
          echo "âœ… Redisé•œåƒæµ‹è¯•å®Œæˆ"

  # åˆ›å»ºGitHub Release
  create-release:
    needs: [setup, check-modules, test-php-image, test-nginx-image, test-mariadb-image, test-redis-image]
    runs-on: ubuntu-latest
    if: ${{ (success() || always()) && needs.setup.outputs.rebuild_type != 'test' && needs.check-modules.outputs.changed_modules != '' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®æ—¥æœŸå˜é‡
        id: set_date
        run: |
          echo "TODAY=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: åˆ›å»ºGitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TIMESTAMP }}
          release_name: é•œåƒæ›´æ–° - ${{ env.TODAY }}
          body: |
            ## æ„å»ºä¿¡æ¯
            - æ„å»ºæ¨¡å—: ${{ needs.setup.outputs.modules }}
            - å®é™…é‡æ„æ¨¡å—: ${{ needs.check-modules.outputs.changed_modules || 'æ— ' }}
            - é‡æ„ç±»å‹: ${{ needs.setup.outputs.rebuild_type }}
            - è‡ªåŠ¨éƒ¨ç½²: ${{ needs.setup.outputs.is_auto_deploy }}
            
            ## ç‰ˆæœ¬ä¿¡æ¯
            - PHPç‰ˆæœ¬: ${{ needs.setup.outputs.php_version }}
            - Nginxç‰ˆæœ¬: ${{ needs.setup.outputs.nginx_version }}
            - MariaDBç‰ˆæœ¬: ${{ needs.setup.outputs.mariadb_version }}
            - Redisç‰ˆæœ¬: ${{ needs.setup.outputs.redis_version }}
            - Alpineç‰ˆæœ¬: ${{ needs.setup.outputs.alpine_version }}
            
            ## å˜æ›´è¯¦æƒ…
            - åŸºç¡€é•œåƒå˜æ›´: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' }}
            - åŠŸèƒ½æ¨¡å—å˜æ›´: ${{ needs.check-modules.outputs.changed_modules != '' }}
          draft: false
          prerelease: false

  # æ¸…ç†å’Œæ€»ç»“
  cleanup:
    needs: [setup, check-modules, test-php-image, test-nginx-image, test-mariadb-image, test-redis-image, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: æ¸…ç†
        run: |
          # æ¸…ç†æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶
          echo "æ¸…ç†æ„å»ºç¯å¢ƒ..."
      
      - name: æ€»ç»“
        run: |
          echo "âœ… é•œåƒæ„å»ºå·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "æ„å»ºå‚æ•°ï¼š"
            echo "- æ„å»ºæ¨¡å—: ${{ needs.setup.outputs.modules }}"
            echo "- å®é™…é‡æ„æ¨¡å—: ${{ needs.check-modules.outputs.changed_modules || 'æ— ' }}"
            echo "- é‡æ„ç±»å‹: ${{ needs.setup.outputs.rebuild_type }}"
            echo "- æµ‹è¯•æ¨¡å¼: ${{ needs.setup.outputs.test_mode }}"
            echo "- è‡ªåŠ¨éƒ¨ç½²: ${{ needs.setup.outputs.is_auto_deploy }}"
            
            echo "\nç‰ˆæœ¬ä¿¡æ¯ï¼š"
            echo "- PHPç‰ˆæœ¬: ${{ needs.setup.outputs.php_version }}"
            echo "- Nginxç‰ˆæœ¬: ${{ needs.setup.outputs.nginx_version }}"
            echo "- MariaDBç‰ˆæœ¬: ${{ needs.setup.outputs.mariadb_version }}"
            echo "- Redisç‰ˆæœ¬: ${{ needs.setup.outputs.redis_version }}"
            echo "- Alpineç‰ˆæœ¬: ${{ needs.setup.outputs.alpine_version }}"
            
            echo "\nå‘å¸ƒä¿¡æ¯ï¼š"
            if [ "${{ needs.setup.outputs.rebuild_type }}" != "test" ]; then
              if [ "${{ needs.create-release.result }}" = "success" ]; then
                echo "âœ… GitHub Releaseå·²åˆ›å»º"
              else
                echo "âš ï¸ æœªåˆ›å»ºReleaseï¼ˆå¯èƒ½å› ä¸ºæ²¡æœ‰éœ€è¦é‡æ„çš„æ¨¡å—ï¼‰"
              fi
              echo "ğŸ’¡ æ³¨ï¼šè„šæœ¬æ›´æ–°çš„å¿«é€Ÿå‘å¸ƒç”±version-monitor.ymlå·¥ä½œæµå¤„ç†"
            fi