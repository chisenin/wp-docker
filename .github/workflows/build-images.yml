name: 镜像构建工作流

on:
  repository_dispatch:
    types: [build-images]
  workflow_dispatch:
    # 允许手动触发
    inputs:
      modules:
        description: '要构建的模块（base,php,nginx），多个用逗号分隔'
        required: true
        default: 'base,php,nginx'
        type: string
      rebuild_type:
        description: '重构类型（full/partial）'
        required: false
        default: 'full'
        type: string
      php_version:
        description: 'PHP版本'
        required: false
        default: '8.3'
        type: string
      nginx_version:
        description: 'Nginx版本'
        required: false
        default: '1.27.2'
        type: string
      alpine_version:
        description: 'Alpine版本'
        required: false
        default: '3.20'
        type: string

jobs:
  # 准备环境和设置构建参数
  setup:
    runs-on: ubuntu-latest
    outputs:
      php_version: ${{ steps.prepare-params.outputs.php_version }}
      nginx_version: ${{ steps.prepare-params.outputs.nginx_version }}
      alpine_version: ${{ steps.prepare-params.outputs.alpine_version }}
      modules: ${{ steps.prepare-params.outputs.modules }}
      rebuild_type: ${{ steps.prepare-params.outputs.rebuild_type }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 准备构建参数
        id: prepare-params
        run: |
          # 从client_payload或workflow_dispatch输入获取参数
          if [ -n "${{ github.event.client_payload.modules }}" ]; then
            MODULES="${{ github.event.client_payload.modules }}"
          else
            MODULES="${{ github.event.inputs.modules }}"
          fi
          
          if [ -n "${{ github.event.client_payload.rebuild_type }}" ]; then
            REBUILD_TYPE="${{ github.event.client_payload.rebuild_type }}"
          else
            REBUILD_TYPE="${{ github.event.inputs.rebuild_type }}"
          fi
          
          if [ -n "${{ github.event.client_payload.php_version }}" ]; then
            PHP_VERSION="${{ github.event.client_payload.php_version }}"
          else
            PHP_VERSION="${{ github.event.inputs.php_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.nginx_version }}" ]; then
            NGINX_VERSION="${{ github.event.client_payload.nginx_version }}"
          else
            NGINX_VERSION="${{ github.event.inputs.nginx_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.alpine_version }}" ]; then
            ALPINE_VERSION="${{ github.event.client_payload.alpine_version }}"
          else
            ALPINE_VERSION="${{ github.event.inputs.alpine_version }}"
          fi
          
          echo "构建参数："
          echo "- 模块: $MODULES"
          echo "- 重构类型: $REBUILD_TYPE"
          echo "- PHP版本: $PHP_VERSION"
          echo "- Nginx版本: $NGINX_VERSION"
          echo "- Alpine版本: $ALPINE_VERSION"
          
          # 设置输出
          echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "rebuild_type=$REBUILD_TYPE" >> $GITHUB_OUTPUT
          
          # 保存版本信息
          mkdir -p build/Dockerfiles/php build/Dockerfiles/nginx build/Dockerfiles/mariadb build/Dockerfiles/redis build/Dockerfiles/base
          echo "$PHP_VERSION" > build/Dockerfiles/php/php_version.txt
          echo "$NGINX_VERSION" > build/Dockerfiles/nginx/nginx_version.txt
          echo "$ALPINE_VERSION" > build/Dockerfiles/base/alpine_version.txt

  # 构建基础镜像
  build-base-image:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送基础镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/base
          file: ./build/Dockerfiles/base/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            ALPINE_VERSION=${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-base:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}

  # 构建PHP镜像
  build-php-image:
    needs: [setup, build-base-image]
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'php') || needs.setup.outputs.rebuild_type == 'full' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送PHP镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/php
          file: ./build/Dockerfiles/php/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            PHP_VERSION=${{ needs.setup.outputs.php_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}-${{ github.sha }}

  # 测试PHP镜像
  test-php-image:
    needs: build-php-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行PHP镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -v
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -m | grep -E 'curl|gd|mbstring|mysqli|pdo_mysql|redis|zip'
          
          # 验证WordPress所需的PHP扩展是否已安装
          EXTENSIONS=("curl" "gd" "mbstring" "mysqli" "pdo_mysql" "redis" "zip" "imagick")
          for ext in "${EXTENSIONS[@]}"; do
            if docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -m | grep -q "$ext"; then
              echo "✅ PHP扩展 $ext 已安装"
            else
              echo "❌ PHP扩展 $ext 未安装"
              exit 1
            fi
          done

  # 构建Nginx镜像
  build-nginx-image:
    needs: [setup, build-base-image]
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'nginx') || needs.setup.outputs.rebuild_type == 'full' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送Nginx镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/nginx
          file: ./build/Dockerfiles/nginx/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            NGINX_VERSION=${{ needs.setup.outputs.nginx_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}-${{ github.sha }}

  # 测试Nginx镜像
  test-nginx-image:
    needs: build-nginx-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行Nginx镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -v
          
          # 验证Nginx配置是否正确
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -t
          
          # 验证是否包含WordPress所需的配置
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -T | grep -q "php-fpm"
          if [ $? -eq 0 ]; then
            echo "✅ WordPress Nginx配置已正确包含"
          else
            echo "❌ WordPress Nginx配置未找到"
            exit 1
          fi

  # 清理和总结
  cleanup:
    needs: [test-php-image, test-nginx-image]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 清理
        run: |
          # 清理构建过程中的临时文件
          echo "清理构建环境..."
      
      - name: 总结
        run: |
          echo "✅ 镜像构建工作流执行完成"
          echo "构建模块: ${{ needs.setup.outputs.modules }}"
          echo "重构类型: ${{ needs.setup.outputs.rebuild_type }}"
          echo "PHP版本: ${{ needs.setup.outputs.php_version }}"
          echo "Nginx版本: ${{ needs.setup.outputs.nginx_version }}"
          echo "Alpine版本: ${{ needs.setup.outputs.alpine_version }}"