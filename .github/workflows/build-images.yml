name: 镜像构建工作流

permissions:
  contents: write
  actions: write
  packages: write

on:
  repository_dispatch:
    types: [build-images]
  workflow_dispatch:
    # 允许手动触发
    inputs:
      modules:
        description: '要构建的模块（base,php,nginx,mariadb,redis），多个用逗号分隔'
        required: true
        default: 'base,php,nginx,mariadb,redis'
        type: string
      rebuild_type:
        description: '重构类型（full/partial/test）'
        required: false
        default: 'full'
        type: string
      test_mode:
        description: '测试模式（true/false），测试模式下构建所有功能模块'
        required: false
        default: 'false'
        type: string
      php_version:
        description: 'PHP版本'
        required: false
        default: '8.3'
        type: string
      nginx_version:
        description: 'Nginx版本'
        required: false
        default: '1.27.2'
        type: string
      mariadb_version:
        description: 'MariaDB版本'
        required: false
        default: '10.11'
        type: string
      redis_version:
        description: 'Redis版本'
        required: false
        default: '7.2'
        type: string
      alpine_version:
        description: 'Alpine版本'
        required: false
        default: '3.20'
        type: string

jobs:
  # 准备环境和设置构建参数
  setup:
    runs-on: ubuntu-latest
    outputs:
      php_version: ${{ steps.prepare-params.outputs.php_version }}
      nginx_version: ${{ steps.prepare-params.outputs.nginx_version }}
      alpine_version: ${{ steps.prepare-params.outputs.alpine_version }}
      modules: ${{ steps.prepare-params.outputs.modules }}
      rebuild_type: ${{ steps.prepare-params.outputs.rebuild_type }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 准备构建参数
        id: prepare-params
        run: |
          # 从client_payload或workflow_dispatch输入获取参数
          if [ -n "${{ github.event.client_payload.modules }}" ]; then
            MODULES="${{ github.event.client_payload.modules }}"
          else
            MODULES="${{ github.event.inputs.modules }}"
          fi
          
          if [ -n "${{ github.event.client_payload.rebuild_type }}" ]; then
            REBUILD_TYPE="${{ github.event.client_payload.rebuild_type }}"
          else
            REBUILD_TYPE="${{ github.event.inputs.rebuild_type }}"
          fi
          
          # 获取测试模式
          if [ -n "${{ github.event.client_payload.test_mode }}" ]; then
            TEST_MODE="${{ github.event.client_payload.test_mode }}"
          else
            TEST_MODE="${{ github.event.inputs.test_mode }}"
          fi
          
          if [ -n "${{ github.event.client_payload.php_version }}" ]; then
            PHP_VERSION="${{ github.event.client_payload.php_version }}"
          else
            PHP_VERSION="${{ github.event.inputs.php_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.nginx_version }}" ]; then
            NGINX_VERSION="${{ github.event.client_payload.nginx_version }}"
          else
            NGINX_VERSION="${{ github.event.inputs.nginx_version }}"
          fi
          
          if [ -n "${{ github.event.client_payload.alpine_version }}" ]; then
            ALPINE_VERSION="${{ github.event.client_payload.alpine_version }}"
          else
            ALPINE_VERSION="${{ github.event.inputs.alpine_version }}"
          fi
          
          # 获取MariaDB版本
          if [ -n "${{ github.event.client_payload.mariadb_version }}" ]; then
            MARIADB_VERSION="${{ github.event.client_payload.mariadb_version }}"
          else
            MARIADB_VERSION="${{ github.event.inputs.mariadb_version }}"
          fi
          
          # 获取Redis版本
          if [ -n "${{ github.event.client_payload.redis_version }}" ]; then
            REDIS_VERSION="${{ github.event.client_payload.redis_version }}"
          else
            REDIS_VERSION="${{ github.event.inputs.redis_version }}"
          fi
          
          # 测试模式下强制构建所有功能模块
          if [ "$TEST_MODE" = "true" ] || [ "$REBUILD_TYPE" = "test" ]; then
            echo "⚠️ 测试模式：构建所有功能模块"
            REBUILD_TYPE="test"
            MODULES="base,php,nginx,mariadb,redis"
          fi
          
          echo "构建参数："
          echo "- 模块: $MODULES"
          echo "- 重构类型: $REBUILD_TYPE"
          echo "- 测试模式: $TEST_MODE"
          echo "- PHP版本: $PHP_VERSION"
          echo "- Nginx版本: $NGINX_VERSION"
          echo "- MariaDB版本: $MARIADB_VERSION"
          echo "- Redis版本: $REDIS_VERSION"
          echo "- Alpine版本: $ALPINE_VERSION"
          
          # 设置输出
          echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
          echo "mariadb_version=$MARIADB_VERSION" >> $GITHUB_OUTPUT
          echo "redis_version=$REDIS_VERSION" >> $GITHUB_OUTPUT
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "rebuild_type=$REBUILD_TYPE" >> $GITHUB_OUTPUT
          echo "test_mode=$TEST_MODE" >> $GITHUB_OUTPUT
          
          # 保存版本信息
          mkdir -p build/Dockerfiles/php build/Dockerfiles/nginx build/Dockerfiles/mariadb build/Dockerfiles/redis build/Dockerfiles/base
          echo "$PHP_VERSION" > build/Dockerfiles/php/php_version.txt
          echo "$NGINX_VERSION" > build/Dockerfiles/nginx/nginx_version.txt
          echo "$MARIADB_VERSION" > build/Dockerfiles/mariadb/mariadb_version.txt
          echo "$REDIS_VERSION" > build/Dockerfiles/redis/redis_version.txt
          echo "$ALPINE_VERSION" > build/Dockerfiles/base/alpine_version.txt

  # 构建基础镜像
  build-base-image:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送基础镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/base
          file: ./build/Dockerfiles/base/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            ALPINE_VERSION=${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-base:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}

  # 构建PHP镜像
  build-php-image:
    needs: [setup, build-base-image]
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'php') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送PHP镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/php
          file: ./build/Dockerfiles/php/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            PHP_VERSION=${{ needs.setup.outputs.php_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}-${{ github.sha }}

  # 测试PHP镜像
  test-php-image:
    needs: build-php-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行PHP镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -v
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -m | grep -E 'curl|gd|mbstring|mysqli|pdo_mysql|redis|zip'
          
          # 验证WordPress所需的PHP扩展是否已安装
          EXTENSIONS=("curl" "gd" "mbstring" "mysqli" "pdo_mysql" "redis" "zip" "imagick")
          for ext in "${EXTENSIONS[@]}"; do
            if docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-php:latest php -m | grep -q "$ext"; then
              echo "✅ PHP扩展 $ext 已安装"
            else
              echo "❌ PHP扩展 $ext 未安装"
              exit 1
            fi
          done

  # 构建Nginx镜像
  build-nginx-image:
    needs: [setup, build-base-image]
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'nginx') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送Nginx镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/nginx
          file: ./build/Dockerfiles/nginx/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            NGINX_VERSION=${{ needs.setup.outputs.nginx_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}-${{ github.sha }}

  # 测试Nginx镜像
  test-nginx-image:
    needs: build-nginx-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行Nginx镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -v
          
          # 验证Nginx配置是否正确
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -t
          
          # 验证是否包含WordPress所需的配置
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-nginx:latest nginx -T | grep -q "php-fpm"
          if [ $? -eq 0 ]; then
            echo "✅ WordPress Nginx配置已正确包含"
          else
            echo "❌ WordPress Nginx配置未找到"
            exit 1
          fi

  # 构建MariaDB镜像
  build-mariadb-image:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'mariadb') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送MariaDB镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/mariadb
          file: ./build/Dockerfiles/mariadb/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            MARIADB_VERSION=${{ needs.setup.outputs.mariadb_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}-${{ github.sha }}

  # 测试MariaDB镜像
  test-mariadb-image:
    needs: build-mariadb-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行MariaDB镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:latest
          
          # 运行简单的测试命令
          docker run --rm --entrypoint=mysql ${{ secrets.DOCKER_USERNAME }}/wp-docker-mariadb:latest --version
          
          # 验证MariaDB配置
          echo "✅ MariaDB镜像测试完成"

  # 构建Redis镜像
  build-redis-image:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ contains(needs.setup.outputs.modules, 'redis') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: 构建并推送Redis镜像
        uses: docker/build-push-action@v5
        with:
          context: ./build/Dockerfiles/redis
          file: ./build/Dockerfiles/redis/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args:
            REDIS_VERSION=${{ needs.setup.outputs.redis_version }}
            BASE_IMAGE=${{ secrets.DOCKER_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}
          tags:
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:latest
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}
            ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}-${{ github.sha }}

  # 测试Redis镜像
  test-redis-image:
    needs: build-redis-image
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行Redis镜像测试
        run: |
          # 拉取构建的镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:latest
          
          # 运行简单的测试命令
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/wp-docker-redis:latest redis-server --version
          
          # 验证Redis配置
          echo "✅ Redis镜像测试完成"

  # 创建GitHub Release
  create-release:
    needs: [test-php-image, test-nginx-image, test-mariadb-image, test-redis-image]
    runs-on: ubuntu-latest
    if: ${{ success() && needs.setup.outputs.rebuild_type != 'test' }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置日期变量
        id: set_date
        run: |
          echo "TODAY=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: 创建GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TIMESTAMP }}
          release_name: 镜像更新 - ${{ env.TODAY }}
          body: |
            ## 镜像更新详情
            - 构建模块: ${{ needs.setup.outputs.modules }}
            - 重构类型: ${{ needs.setup.outputs.rebuild_type }}
            - PHP版本: ${{ needs.setup.outputs.php_version }}
            - Nginx版本: ${{ needs.setup.outputs.nginx_version }}
            - MariaDB版本: ${{ needs.setup.outputs.mariadb_version }}
            - Redis版本: ${{ needs.setup.outputs.redis_version }}
            - Alpine版本: ${{ needs.setup.outputs.alpine_version }}
          draft: false
          prerelease: false

  # 清理和总结
  cleanup:
    needs: [test-php-image, test-nginx-image, test-mariadb-image, test-redis-image, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 清理
        run: |
          # 清理构建过程中的临时文件
          echo "清理构建环境..."
      
      - name: 总结
        run: |
          echo "✅ 镜像构建工作流执行完成"
          echo "构建模块: ${{ needs.setup.outputs.modules }}"
          echo "重构类型: ${{ needs.setup.outputs.rebuild_type }}"
          echo "测试模式: ${{ needs.setup.outputs.test_mode }}"
          echo "PHP版本: ${{ needs.setup.outputs.php_version }}"
          echo "Nginx版本: ${{ needs.setup.outputs.nginx_version }}"
          echo "MariaDB版本: ${{ needs.setup.outputs.mariadb_version }}"
          echo "Redis版本: ${{ needs.setup.outputs.redis_version }}"
          echo "Alpine版本: ${{ needs.setup.outputs.alpine_version }}"
          if [ "${{ needs.setup.outputs.rebuild_type }}" != "test" ] && [ "${{ needs.create-release.result }}" = "success" ]; then
            echo "✅ GitHub Release已创建"
          fi