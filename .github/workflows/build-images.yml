name: 闀滃儚鏋勫缓宸ヤ綔娴?
\non:\n  push:\n    branches: [ main ]\n    paths:\n      - '.github/workflows/build-images.yml'\n      - 'build/Dockerfiles/**'\n  pull_request:\n    branches: [ main ]\n    paths:\n      - '.github/workflows/build-images.yml'\n      - 'build/Dockerfiles/**'\n  workflow_dispatch:\n    inputs:\n      rebuild_type:\n        description: '鏋勫缓绫诲瀷'\n        required: true\n        default: 'incremental'\n        type: choice\n        options:\n          - incremental\n          - full\n          - test\n\njobs:\n  setup:\n    runs-on: ubuntu-latest\n    outputs:\n      alpine_version: ${{ steps.set-versions.outputs.alpine_version }}\n      php_version: ${{ steps.set-versions.outputs.php_version }}\n      nginx_version: ${{ steps.set-versions.outputs.nginx_version }}\n      mariadb_version: ${{ steps.set-versions.outputs.mariadb_version }}\n      redis_version: ${{ steps.set-versions.outputs.redis_version }}\n      rebuild_type: ${{ steps.set-rebuild-type.outputs.rebuild_type }}\n      modules: ${{ steps.detect-changes.outputs.modules }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n\n      - name: 璁剧疆鏋勫缓绫诲瀷\n        id: set-rebuild-type\n        run: |\n          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then\n            echo "rebuild_type=${{ github.event.inputs.rebuild_type }}" >> $GITHUB_OUTPUT\n          else\n            echo "rebuild_type=incremental" >> $GITHUB_OUTPUT\n          fi\n\n      - name: 璁剧疆鐗堟湰鍙?
        id: set-versions\n        run: |\n          # 浠嶥ockerfile涓彁鍙栫増鏈俊鎭?
          ALPINE_VERSION=$(grep -oP 'FROM alpine:\K[^\s]+' build/Dockerfiles/base/Dockerfile)\n          PHP_VERSION=$(grep -oP 'ARG PHP_VERSION=\K[^\s]+' build/Dockerfiles/php/Dockerfile)\n          NGINX_VERSION=$(grep -oP 'ARG NGINX_VERSION=\K[^\s]+' build/Dockerfiles/nginx/Dockerfile)\n          MARIADB_VERSION=$(grep -oP 'ARG MARIADB_VERSION=\K[^\s]+' build/Dockerfiles/mariadb/Dockerfile)\n          REDIS_VERSION=$(grep -oP 'ARG REDIS_VERSION=\K[^\s]+' build/Dockerfiles/redis/Dockerfile)\n          \n          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT\n          echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT\n          echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT\n          echo "mariadb_version=$MARIADB_VERSION" >> $GITHUB_OUTPUT\n          echo "redis_version=$REDIS_VERSION" >> $GITHUB_OUTPUT\n\n      - name: 妫€娴嬪彉鏇存ā鍧?
        id: detect-changes\n        run: |\n          # 妫€娴嬪摢浜涙ā鍧楀彂鐢熶簡鍙樻洿\n          MODULES=""\n          \n          if [[ "${{ steps.set-rebuild-type.outputs.rebuild_type }}" == "full" || "${{ steps.set-rebuild-type.outputs.rebuild_type }}" == "test" ]]; then\n            MODULES="base,php,nginx,mariadb,redis"\n          else\n            # 妫€鏌ユ瘡涓ā鍧楃殑鍙樻洿\n            if [[ "${{ github.event_name }}" == "pull_request" ]]; then\n              CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})\n            else\n              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)\n            fi\n            \n            # 妫€鏌ュ熀纭€闀滃儚鍙樻洿\n            if echo "$CHANGED_FILES" | grep -q "build/Dockerfiles/base/"; then\n              MODULES="base"\n            fi\n            \n            # 妫€鏌HP闀滃儚鍙樻洿\n            if echo "$CHANGED_FILES" | grep -q "build/Dockerfiles/php/"; then\n              MODULES="${MODULES}${MODULES:+,}php"\n            fi\n            \n            # 妫€鏌ginx闀滃儚鍙樻洿\n            if echo "$CHANGED_FILES" | grep -q "build/Dockerfiles/nginx/"; then\n              MODULES="${MODULES}${MODULES:+,}nginx"\n            fi\n            \n            # 妫€鏌ariaDB闀滃儚鍙樻洿\n            if echo "$CHANGED_FILES" | grep -q "build/Dockerfiles/mariadb/"; then\n              MODULES="${MODULES}${MODULES:+,}mariadb"\n            fi\n            \n            # 妫€鏌edis闀滃儚鍙樻洿\n            if echo "$CHANGED_FILES" | grep -q "build/Dockerfiles/redis/"; then\n              MODULES="${MODULES}${MODULES:+,}redis"\n            fi\n          fi\n          \n          echo "modules=$MODULES" >> $GITHUB_OUTPUT\n          echo "妫€娴嬪埌闇€瑕佹瀯寤虹殑妯″潡: $MODULES"\n\n  # 鏋勫缓鍩虹闀滃儚\n  build-base-image:\n    needs: setup\n    runs-on: ubuntu-latest\n    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 璁剧疆Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: 鐧诲綍DockerHub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: 鏋勫缓骞舵帹閫佸熀纭€闀滃儚\n        uses: docker/build-push-action@v5\n        with:\n          context: ./build/Dockerfiles/base\n          file: ./build/Dockerfiles/base/Dockerfile\n          push: true\n          platforms: linux/amd64,linux/arm64\n          build-args:\n            ALPINE_VERSION=${{ needs.setup.outputs.alpine_version }}\n          tags:\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:latest\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n        continue-on-error: true\n\n  # 妫€鏌ュ姛鑳芥ā鍧楁槸鍚﹂渶瑕侀噸鏋?
  check-modules:\n    needs: [setup, build-base-image]\n    runs-on: ubuntu-latest\n    if: ${{ contains(needs.setup.outputs.modules, 'base') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' }}\n    outputs:\n      rebuild_php: ${{ steps.module-check.outputs.rebuild_php }}\n      rebuild_nginx: ${{ steps.module-check.outputs.rebuild_nginx }}\n      rebuild_mariadb: ${{ steps.module-check.outputs.rebuild_mariadb }}\n      rebuild_redis: ${{ steps.module-check.outputs.rebuild_redis }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 妫€鏌ヤ緷璧栨ā鍧?
        id: module-check\n        run: |\n          # 濡傛灉鍩虹闀滃儚鍙樻洿锛屾墍鏈変緷璧栨ā鍧楅兘闇€瑕侀噸寤?
          echo "rebuild_php=true" >> $GITHUB_OUTPUT\n          echo "rebuild_nginx=true" >> $GITHUB_OUTPUT\n          echo "rebuild_mariadb=true" >> $GITHUB_OUTPUT\n          echo "rebuild_redis=true" >> $GITHUB_OUTPUT\n\n  # 鏋勫缓PHP闀滃儚\n  build-php-image:\n    needs: [setup, build-base-image, check-modules]\n    runs-on: ubuntu-latest\n    if: ${{ contains(needs.setup.outputs.modules, 'php') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' || needs.check-modules.outputs.rebuild_php == 'true' }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 璁剧疆Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: 鐧诲綍DockerHub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: 鏋勫缓骞舵帹閫丳HP闀滃儚\n        uses: docker/build-push-action@v5\n        with:\n          context: ./build/Dockerfiles/php\n          file: ./build/Dockerfiles/php/Dockerfile\n          push: true\n          platforms: linux/amd64,linux/arm64\n          build-args:\n            PHP_VERSION=${{ needs.setup.outputs.php_version }}\n            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}\n          tags:\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:latest\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}-${{ github.sha }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n        continue-on-error: true\n\n  # 娴嬭瘯PHP闀滃儚\n  test-php-image:\n    needs: build-php-image\n    runs-on: ubuntu-latest\n    if: ${{ always() }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 杩愯PHP闀滃儚娴嬭瘯\n        run: |\n          echo "娴嬭瘯PHP闀滃儚: ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}"\n          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }}\n          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }} php -v\n          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-php:${{ needs.setup.outputs.php_version }} php -m\n\n  # 鏋勫缓Nginx闀滃儚\n  build-nginx-image:\n    needs: [setup, build-base-image, check-modules]\n    runs-on: ubuntu-latest\n    if: ${{ contains(needs.setup.outputs.modules, 'nginx') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' || needs.check-modules.outputs.rebuild_nginx == 'true' }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 璁剧疆Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: 鐧诲綍DockerHub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: 鏋勫缓骞舵帹閫丯ginx闀滃儚\n        uses: docker/build-push-action@v5\n        with:\n          context: ./build/Dockerfiles/nginx\n          file: ./build/Dockerfiles/nginx/Dockerfile\n          push: true\n          platforms: linux/amd64,linux/arm64\n          build-args:\n            NGINX_VERSION=${{ needs.setup.outputs.nginx_version }}\n            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}\n          tags:\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:latest\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}-${{ github.sha }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n        continue-on-error: true\n\n  # 娴嬭瘯Nginx闀滃儚\n  test-nginx-image:\n    needs: build-nginx-image\n    runs-on: ubuntu-latest\n    if: ${{ always() }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 杩愯Nginx闀滃儚娴嬭瘯\n        run: |\n          echo "娴嬭瘯Nginx闀滃儚: ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}"\n          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }}\n          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }} nginx -v\n          # 楠岃瘉閰嶇疆\n          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-nginx:${{ needs.setup.outputs.nginx_version }} nginx -t\n\n  # 鏋勫缓MariaDB闀滃儚\n  build-mariadb-image:\n    needs: [setup, build-base-image, check-modules]\n    runs-on: ubuntu-latest\n    if: ${{ contains(needs.setup.outputs.modules, 'mariadb') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' || needs.check-modules.outputs.rebuild_mariadb == 'true' }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 璁剧疆Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: 鐧诲綍DockerHub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: 鏋勫缓骞舵帹閫丮ariaDB闀滃儚\n        uses: docker/build-push-action@v5\n        with:\n          context: ./build/Dockerfiles/mariadb\n          file: ./build/Dockerfiles/mariadb/Dockerfile\n          push: true\n          platforms: linux/amd64,linux/arm64\n          build-args:\n            MARIADB_VERSION=${{ needs.setup.outputs.mariadb_version }}\n            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}\n          tags:\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:latest\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}-${{ github.sha }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n        continue-on-error: true\n\n  # 娴嬭瘯MariaDB闀滃儚\n  test-mariadb-image:\n    needs: build-mariadb-image\n    runs-on: ubuntu-latest\n    if: ${{ always() }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 杩愯MariaDB闀滃儚娴嬭瘯\n        run: |\n          echo "娴嬭瘯MariaDB闀滃儚: ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}"\n          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }}\n          # 鍚姩MariaDB瀹瑰櫒\n          CONTAINER_ID=$(docker run -d -e MARIADB_ROOT_PASSWORD=test -p 3306:3306 ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-mariadb:${{ needs.setup.outputs.mariadb_version }})\n          # 绛夊緟鏈嶅姟鍚姩\n          sleep 10\n          # 娴嬭瘯杩炴帴\n          docker exec $CONTAINER_ID mysql -u root -ptest -e "SELECT VERSION();"\n          # 娓呯悊\n          docker stop $CONTAINER_ID\n          docker rm $CONTAINER_ID\n\n  # 鏋勫缓Redis闀滃儚\n  build-redis-image:\n    needs: [setup, build-base-image, check-modules]\n    runs-on: ubuntu-latest\n    if: ${{ contains(needs.setup.outputs.modules, 'redis') || needs.setup.outputs.rebuild_type == 'full' || needs.setup.outputs.rebuild_type == 'test' || needs.check-modules.outputs.rebuild_redis == 'true' }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 璁剧疆Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: 鐧诲綍DockerHub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: 鏋勫缓骞舵帹閫丷edis闀滃儚\n        uses: docker/build-push-action@v5\n        with:\n          context: ./build/Dockerfiles/redis\n          file: ./build/Dockerfiles/redis/Dockerfile\n          push: true\n          platforms: linux/amd64,linux/arm64\n          build-args:\n            REDIS_VERSION=${{ needs.setup.outputs.redis_version }}\n            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-base:${{ needs.setup.outputs.alpine_version }}\n          tags:\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:latest\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}\n            - ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}-${{ github.sha }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n        continue-on-error: true\n\n  # 娴嬭瘯Redis闀滃儚\n  test-redis-image:\n    needs: build-redis-image\n    runs-on: ubuntu-latest\n    if: ${{ always() }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n\n      - name: 杩愯Redis闀滃儚娴嬭瘯\n        run: |\n          echo "娴嬭瘯Redis闀滃儚: ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}"\n          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }}\n          # 鍚姩Redis瀹瑰櫒\n          CONTAINER_ID=$(docker run -d -p 6379:6379 ${{ secrets.DOCKERHUB_USERNAME }}/wp-docker-redis:${{ needs.setup.outputs.redis_version }})\n          # 绛夊緟鏈嶅姟鍚姩\n          sleep 5\n          # 娴嬭瘯杩炴帴\n          docker exec $CONTAINER_ID redis-cli ping\n          # 娴嬭瘯鐗堟湰\n          docker exec $CONTAINER_ID redis-cli info server | grep redis_version\n          # 娓呯悊\n          docker stop $CONTAINER_ID\n          docker rm $CONTAINER_ID\n\n  # 鍒涘缓GitHub Release\n  create-release:\n    needs: [setup, test-php-image, test-nginx-image, test-mariadb-image, test-redis-image]\n    runs-on: ubuntu-latest\n    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.setup.outputs.rebuild_type == 'full' }}\n    steps:\n      - name: 妫€鍑轰唬鐮?
        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n\n      - name: 鐢熸垚鐗堟湰鍙?
        id: generate-version\n        run: |\n          # 浣跨敤鏃ユ湡浣滀负鐗堟湰鍙?
          VERSION=$(date +"%Y%m%d")\n          # 妫€鏌ユ槸鍚﹀凡瀛樺湪璇ョ増鏈?
          if git tag | grep -q "v$VERSION"; then\n            # 濡傛灉瀛樺湪锛屾坊鍔犳瀯寤哄彿\n            BUILD_NUM=$(git tag | grep "v$VERSION" | wc -l)\n            VERSION="${VERSION}.${BUILD_NUM}"\n          fi\n          echo "version=v$VERSION" >> $GITHUB_OUTPUT\n          echo "鍒涘缓鐗堟湰: v$VERSION"\n\n      - name: 鍒涘缓Release\n        uses: actions/create-release@v1\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n        with:\n          tag_name: ${{ steps.generate-version.outputs.version }}\n          release_name: Release ${{ steps.generate-version.outputs.version }}\n          body: |\n            鑷姩鏋勫缓鐗堟湰 ${{ steps.generate-version.outputs.version }}\n            \n            **闀滃儚鐗堟湰:**\n            - Base: ${{ needs.setup.outputs.alpine_version }}\n            - PHP: ${{ needs.setup.outputs.php_version }}\n            - Nginx: ${{ needs.setup.outputs.nginx_version }}\n            - MariaDB: ${{ needs.setup.outputs.mariadb_version }}\n            - Redis: ${{ needs.setup.outputs.redis_version }}\n          draft: false\n          prerelease: false\n\n  # 娓呯悊宸ヤ綔\n  cleanup:\n    needs: [create-release]\n    runs-on: ubuntu-latest\n    if: ${{ always() }}\n    steps:\n      - name: 娓呯悊鏋勫缓缂撳瓨\n        run: |\n          echo "娓呯悊鏋勫缓缂撳瓨..."\n          # 鍙互娣诲姞娓呯悊Docker缂撳瓨鐨勫懡浠?
          # docker builder prune -f\n