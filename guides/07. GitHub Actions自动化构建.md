## 第七部分：步骤五：GitHub Actions 自动化构建工作流

**文件: `wordpress-project/.github/workflows/build-and-push.yml`**  
这个工作流在推送至 `main` 分支或 PR 时触发：检出代码、登录 Docker Hub、构建共享 base 镜像、构建临时 PHP/Nginx 镜像、提取实际版本、重新标签并推送精确版本（如 :8.3.26）。支持多平台构建（linux/amd64, linux/arm64）。不推送 :latest 标签。版本监控和 Release 脚本功能已注释，待测试完成启用。

```yaml
name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 版本监控（暂关闭，待测试）
  # check-versions:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     trigger_build: ${{ steps.check.outputs.trigger_build }}
  #     php_version: ${{ steps.check.outputs.php_version }}
  #     nginx_version: ${{ steps.check.outputs.nginx_version }}
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Install skopeo and jq
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y skopeo jq
  #     - name: Run version check script
  #       id: check
  #       run: |
  #         chmod +x scripts/check_versions.sh
  #         ./scripts/check_versions.sh
  #     - name: Upload versions artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: versions
  #         path: versions.json

  build:
    # needs: check-versions
    # if: needs.check-versions.outputs.trigger_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build base image (multi-platform)
        uses: docker/build-push-action@v6
        with:
          context: ./Dockerfiles/base
          file: ./Dockerfiles/base/Dockerfile
          push: false  # 不推送 base，仅本地使用
          tags: local/base:3.22
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Fetch latest Composer hash
        id: composer-hash
        run: |
          echo "::group::Composer Hash Verification"
          HASH=$(curl -s --retry 3 https://composer.github.io/installer.sig)
          if [ -z "$HASH" ] || [ ${#HASH} -ne 96 ]; then 
            echo "Error: Invalid Composer hash (length: ${#HASH})"
            exit 1
          fi
          echo "composer_hash=${HASH}" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Build and push PHP temp (multi-platform)
        id: php-build
        uses: docker/build-push-action@v6
        with:
          context: ./Dockerfiles/php
          file: ./Dockerfiles/php/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-php:temp
          platforms: linux/amd64,linux/arm64
          build-args: |
            COMPOSER_HASH=${{ steps.composer-hash.outputs.composer_hash }}
            BASE_IMAGE=local/base:3.22
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Pull amd64 variant and extract PHP version
        run: |
          docker pull --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-php:temp
          ACTUAL_PHP_VERSION=$(docker run --rm --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-php:temp cat /tmp/php_version)
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-php:temp ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-php:${ACTUAL_PHP_VERSION}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-php:${ACTUAL_PHP_VERSION}
          echo "php_version=${ACTUAL_PHP_VERSION}" >> $GITHUB_OUTPUT

      - name: Verify Nginx base image exists
        run: |
          docker pull nginx:1.27-alpine3.22 || docker pull nginx:1.27-alpine

      - name: Build and push Nginx temp (multi-platform)
        id: nginx-build
        uses: docker/build-push-action@v6
        with:
          context: ./Dockerfiles/nginx
          file: ./Dockerfiles/nginx/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:temp
          platforms: linux/amd64,linux/arm64
          build-args: |
            BASE_IMAGE=local/base:3.22
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Pull amd64 variant and extract Nginx version
        run: |
          docker pull --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:temp
          ACTUAL_NGINX_VERSION=$(docker run --rm --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:temp cat /tmp/nginx_version)
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:temp ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:${ACTUAL_NGINX_VERSION}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:${ACTUAL_NGINX_VERSION}
          echo "nginx_version=${ACTUAL_NGINX_VERSION}" >> $GITHUB_OUTPUT

      # Release 脚本（暂关闭，待测试）
      # - name: Create deployment script
      #   run: |
      #     cat > scripts/generate-env-and-compose.sh << 'EOF'
      #     #!/bin/bash
      #     echo "Generating .env and docker-compose.yml..."
      #     cat > .env << EOT
      #     DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
      #     PHP_VERSION=${{ steps.php-build.outputs.php_version }}
      #     NGINX_VERSION=${{ steps.nginx-build.outputs.nginx_version }}
      #     MYSQL_ROOT_PASSWORD=your_strong_root_password
      #     MYSQL_USER=wp_user
      #     MYSQL_PASSWORD=your_strong_user_password
      #     MYSQL_DATABASE=wordpress
      #     EOT
      #     cat > docker-compose.yml << EOT
      #     version: '3.8'
      #     services:
      #       db:
      #         image: mariadb:10.11.14
      #         container_name: wp_db
      #         restart: unless-stopped
      #         networks:
      #           - app-network
      #         volumes:
      #           - db_data:/var/lib/mysql
      #         environment:
      #           MYSQL_ROOT_PASSWORD: \${MYSQL_ROOT_PASSWORD}
      #           MYSQL_DATABASE: \${MYSQL_DATABASE}
      #           MYSQL_USER: \${MYSQL_USER}
      #           MYSQL_PASSWORD: \${MYSQL_PASSWORD}
      #         expose:
      #           - "3306"
      #       redis:
      #         image: redis:8.2.2-alpine3.22
      #         container_name: wp_redis
      #         restart: unless-stopped
      #         networks:
      #           - app-network
      #         command: redis-server --appendonly yes
      #         volumes:
      #           - redis_data:/data
      #         expose:
      #           - "6379"
      #       wp:
      #         image: \${DOCKERHUB_USERNAME}/wordpress-php:\${PHP_VERSION}
      #         container_name: wp_fpm
      #         restart: unless-stopped
      #         networks:
      #           - app-network
      #         volumes:
      #           - ./html:/var/www/html
      #         expose:
      #           - "9000"
      #         depends_on:
      #           - db
      #           - redis
      #         environment:
      #           WORDPRESS_DB_HOST: db:3306
      #           WORDPRESS_DB_USER: \${MYSQL_USER}
      #           WORDPRESS_DB_PASSWORD: \${MYSQL_PASSWORD}
      #           WORDPRESS_DB_NAME: \${MYSQL_DATABASE}
      #           WORDPRESS_REDIS_HOST: redis
      #           WORDPRESS_REDIS_PORT: 6379
      #       nginx:
      #         image: \${DOCKERHUB_USERNAME}/wordpress-nginx:\${NGINX_VERSION}
      #         container_name: wp_nginx
      #         restart: unless-stopped
      #         networks:
      #           - app-network
      #         volumes:
      #           - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf
      #           - ./configs/nginx/conf.d:/etc/nginx/conf.d
      #           - ./html:/var/www/html
      #         ports:
      #           - "80:80"
      #         depends_on:
      #           - wp
      #     networks:
      #       app-network:
      #         driver: bridge
      #     volumes:
      #       db_data:
      #       redis_data:
      #     EOT
      #     echo "Generated .env and docker-compose.yml"
      #     EOF
      #     chmod +x scripts/generate-env-and-compose.sh
      # - name: Create Release
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: v${{ github.sha }}
      #     name: Release with PHP ${{ steps.php-build.outputs.php_version }} and Nginx ${{ steps.nginx-build.outputs.nginx_version }}
      #     body: Built with PHP ${{ steps.php-build.outputs.php_version }} and Nginx ${{ steps.nginx-build.outputs.nginx_version }}
      #     files: |
      #       scripts/generate-env-and-compose.sh
```

**说明**：
- **触发器**：推送或 PR 到 `main` 分支。
- **构建优化**：使用 Buildx 支持多阶段和多平台；gha 缓存加速构建；共享 base 镜像避免重复下载 Alpine。
- **版本提取**：动态提取 PHP/Nginx 版本，仅推送精确标签（如 :8.3.26、:1.27.2）。
- **镜像验证**：Nginx 基础镜像拉取失败时 fallback 到 `nginx:1.27-alpine`，解决“找不到镜像”问题。
- **版本监控（暂关闭）**：已注释 `check-versions` job，未来启用后将定时检查模块更新（Alpine、PHP、Nginx、Composer、apk 包），触发构建。
- **Release 脚本（暂关闭）**：已注释生成 `.env` 和 `docker-compose.yml` 的步骤，未来启用后将作为 Release asset。
- **验证**：可选 docker-compose 测试连通性。

---

**本部分结束**。这是指南的第七部分（步骤五：GitHub Actions 自动化构建工作流）。