## 第七部分：步骤五：GitHub Actions 自动化构建工作流

**文件: `wordpress-project/.github/workflows/build-and-push.yml`**
这个工作流在推送至 `main` 或 `test-nginx-only` 分支或 PR 时触发：检出代码、登录 Docker Hub、构建共享 base 镜像、提取实际版本、构建并推送 Nginx 镜像。支持多平台构建（linux/amd64, linux/arm64）。不推送 :latest 标签。

```yaml
name: Build and Push Docker Images

on:
  push:
    branches: [ main, test-nginx-only ]
  pull_request:
    branches: [ main, test-nginx-only ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 构建并推送 Base 镜像
        run: |
          echo "::group::构建并推送 Base 镜像"
          docker buildx build --platform linux/amd64,linux/arm64 \
            -f ./Dockerfiles/base/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-base:3.22 \
            --push ./Dockerfiles/base > /dev/null 2>&1 || {
              echo "::error::构建或推送 base 镜像失败"
              exit 1
            }
          echo "::endgroup::"

      - name: 提取 PHP 和 Nginx 版本
        id: extract
        run: |
          echo "::group::提取版本"
          PHP_VERSION=$(cat Dockerfiles/php/php_version.txt 2>/dev/null || echo '8.3.26')
          NGINX_VERSION=$(cat Dockerfiles/nginx/nginx_version.txt 2>/dev/null || echo '1.27.2')

          [ ! -f Dockerfiles/php/php_version.txt ] && echo "::warning::PHP 版本文件缺失，默认使用 $PHP_VERSION"
          [ ! -f Dockerfiles/nginx/nginx_version.txt ] && echo "::warning::Nginx 版本文件缺失，默认使用 $NGINX_VERSION"

          echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
          echo "PHP_VERSION=$PHP_VERSION" >> $GITHUB_ENV
          echo "NGINX_VERSION=$NGINX_VERSION" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: 构建并推送 Nginx 镜像
        run: |
          echo "::group::构建并推送 Nginx 镜像"
          docker buildx build --platform linux/amd64,linux/arm64 \
            --build-arg BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/wordpress-base:3.22 \
            --build-arg NGINX_VERSION=${{ steps.extract.outputs.nginx_version }} \
            -f ./Dockerfiles/nginx/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/wordpress-nginx:${{ steps.extract.outputs.nginx_version }} \
            --push . > /dev/null 2>&1 || {
              echo "::error::构建或推送 Nginx 镜像失败"
              exit 1
            }
          echo "::endgroup::"

      - name: Docker Compose 验证（可选）
        run: |
          echo "::group::Docker Compose 验证"

          if [ ! -f docker-compose.yml ]; then
            echo "::error::docker-compose.yml 文件缺失"
            exit 1
          fi

          docker compose --project-directory . up -d > /dev/null 2>&1 || {
            echo "::error::Docker Compose 启动失败"
            exit 1
          }

          sleep 10

          curl -f --connect-timeout 5 --retry 3 http://localhost > /dev/null 2>&1 || {
            echo "::error::服务连通性测试失败"
            docker compose logs || true
            docker compose down || true
            exit 1
          }

          docker compose down > /dev/null 2>&1 || {
            echo "::warning::Docker Compose 停止失败"
          }

          echo "::endgroup::"
```

**说明**：
- **触发器**：推送或 PR 到 `main` 或 `test-nginx-only` 分支。
- **构建优化**：使用 Buildx 支持多阶段和多平台；共享 base 镜像避免重复下载 Alpine；直接推送 base 镜像到 Docker Hub（命名为 `username/wordpress-base:3.22`），解决多架构构建时的 `docker exporter does not currently support exporting manifest lists` 错误。
- **版本提取**：通过文件读取方式获取 PHP/Nginx 版本，使用步骤输出（steps.extract.outputs）传递版本号。仅推送精确标签（如 :8.3.26、:1.27.2 或 :stable-alpine）。
- **镜像构建**：构建 Nginx 镜像时传递了 NGINX_VERSION 构建参数，支持使用稳定版本标签（如 stable-alpine）。
- **输出控制**：命令输出重定向到 /dev/null 以减少日志噪声，仅显示必要的状态信息和错误/警告。
- **验证**：包含可选的 docker-compose 测试连通性步骤，确保构建的镜像能够正常运行。

---

**本部分结束**。这是指南的第七部分（步骤五：GitHub Actions 自动化构建工作流）。