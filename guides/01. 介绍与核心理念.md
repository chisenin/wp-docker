# WordPress + Docker Compose 多阶段构建与生产环境最佳实践指南 (GitHub Actions 自动化版)

**文档位置更新说明**: 本指南及其他相关文档已从根目录移至 `guides/` 目录，便于统一管理和维护。

**检查与修正说明（仅在本输出中注明，后续部分不再重复）**：  
我已仔细检查了原文档。修正点包括：  
- 统一Alpine版本为3.22（原文档中Nginx基础镜像已指定为alpine3.22）。  
- 修复Nginx Dockerfile中缺少的多阶段构建细节（添加了final阶段以优化）。  
- 更新Composer hash为最新（假设2025年10月12日最新为v2.8.12的hash，但实际需动态获取；已保持ARG机制）。  
- 确保所有镜像标签一致，避免潜在的“not found”错误。  
- 优化YAML和Dockerfile的缩进和鲁棒性。  
- 移除冗余的空表格。  
其他部分逻辑完整，无重大错误。指南已分拆为10个部分，第一部分如下。

## 第一部分：介绍与核心理念

本文档旨在提供一个现代化、稳健、安全且易于团队协作管理的 WordPress 生产环境部署方案。我们使用 Docker Compose 进行服务编排，并结合 Docker 的多阶段构建功能，为 PHP-FPM 和 Nginx 服务创建优化的、自定义的基础镜像，并全面采用 Git 进行版本控制。

**新增：GitHub Actions 自动化构建**  
为了实现 CI/CD 自动化，我们将构建过程集成到 GitHub Actions 中。在推送代码到 `main` 分支时，自动构建自定义 PHP 和 Nginx 镜像，并推送至 Docker Hub（或 GitHub Container Registry）。这确保了镜像的一致性和可重复性，减少手动构建的错误。MariaDB 和 Redis 继续使用官方固定版本镜像，无需自定义构建。所有构建均在 GitHub Actions 中完成，无需本地构建硬件。

> **目标：** 构建一个现代化、可扩展、安全且自动化的 WordPress 生产部署体系，适配多架构，兼顾 CI/CD 和线上部署。

**注意：版本监控和 Release 脚本功能**  
计划引入版本监控（定时检查模块更新，触发构建/推送）和 Release 脚本（生成 `.env` 和 `docker-compose.yml` 作为 Release asset），以解决“找不到镜像”问题并简化部署。然而，这些功能目前处于测试阶段，**暂时关闭**，将在后续版本启用。相关实现已在工作流中注释，供未来参考。

**更新内容概览（根据讨论）**  
- ✅ 引入 **build-arg 参数化构建源**：支持构建时动态切换国内/官方源（Actions 中使用官方源）。  
- ✅ 明确 **GitHub Actions 仅用于构建**，部署阶段只需拉取镜像。  
- ✅ 拆分构建与部署职责，保证构建镜像的可复用性与生产稳定性。  
- ✅ **动态版本标签提取**：为避免基础镜像标签 "not found" 错误，使用 minor 版本 + Alpine 3.22 的 latest 拉取，构建中提取实际 patch 版本，推送时使用精确标签，确保基于现代 Alpine 3.22 的确定性锁定。  
- ✅ **去除本地构建**：所有构建移至 GitHub Actions 云端，无需本地硬件。  
- ✅ **共享 Alpine base**：在 Actions 中先构建共享 Alpine base 镜像，PHP 和 Nginx 复用它，避免重复下载 Alpine 层。  
- ✅ **精确标签推送**：仅推送动态提取的精确版本标签（如 :8.3.26），不使用 :latest 以避免不确定性。  
- ✅ **版本监控（计划，暂关闭）**：未来将通过脚本定时检查 Alpine、PHP、Nginx 和依赖包的版本更新，自动触发构建。  
- ✅ **Release 脚本（计划，暂关闭）**：未来将在 Actions 完成后生成 `.env` 和 `docker-compose.yml`，作为 GitHub Release 的唯一 asset。

## 核心理念：工程化基石

在开始之前，理解本方案背后的设计哲学至关重要。这关乎于 **“确定性”** 与 **“协作性”** 之间的权衡。

1.  **彻底避免 `:latest` 的不确定性**：  
    在生产环境中，`:latest` 是不稳定性的代名词。`nginx:latest` 可能今天指向 `1.27.2`，下周就变成 `1.28.0`。这种微小的“漂移”足以引发线上故障。**最佳实践是：永远在生产环境中使用具体的版本号。** 为此，我们引入动态提取机制：在构建时使用 minor 版本 latest 拉取基础镜像，提取实际版本后推送精确标签。

2.  **Alpine：现代与高效的基石**：  
    Alpine Linux 因其极致的小体积和高安全性，成为容器化部署的首选。使用统一的 Alpine 版本（如 `alpine:3.22`）作为所有服务的基础，减少底层环境差异带来的兼容性问题，并受益于最新的安全补丁。

3.  **国内源：构建速度的催化剂**：  
    将 Docker 镜像的包管理源切换到国内镜像源（如阿里云），可显著加快依赖下载速度，优化构建流程（Actions 默认使用官方源，国内源可选）。

4.  **多阶段构建：优化最终镜像**：  
    使用多阶段构建分离开发环境（包含编译工具）和运行环境，最终交付一个干净、轻量且仅包含必要组件的生产镜像。

5.  **配置即代码 (Infrastructure as Code)**：  
    **所有配置文件（`docker-compose.yml`, `nginx.conf`, `php.ini`）都必须纳入版本控制系统（如 Git）**。这是确保环境一致性、可追溯性和团队协作的根本。任何环境变更都应通过代码审查流程（Pull Request）完成。

6.  **CI/CD 自动化：GitHub Actions 的力量**  
    通过 GitHub Actions 实现自动构建、测试和镜像推送，确保每次代码变更后，生产镜像立即可用。这与 Git 工作流无缝集成，支持团队协作。动态标签提取提升了构建鲁棒性，避免手动维护标签的痛点。所有构建在云端完成，无本地依赖。

---

**本部分结束**。这是指南的第一部分（介绍与核心理念）。