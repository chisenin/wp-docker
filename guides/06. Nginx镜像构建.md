## 第六部分：步骤四：构建自定义 Nginx 镜像

**文件: `wordpress-project/Dockerfiles/nginx/Dockerfile`**

```dockerfile
# 使用ARG参数支持动态传入base镜像地址，默认为alpine:3.22作为回退
ARG BASE_IMAGE=alpine:3.22
FROM ${BASE_IMAGE} AS base

FROM nginx:1.27-alpine3.22 AS builder

# 提取实际 Nginx 版本（写入 /tmp/nginx_version，用于动态标签）
RUN nginx -v 2>&1 | cut -d'/' -f2 | cut -d' ' -f1 > /tmp/nginx_version || echo "1.27" > /tmp/nginx_version

COPY --from=base /etc/apk/repositories /etc/apk/repositories

# 更新包索引
RUN apk update --no-cache

# 安装调试工具
RUN apk add --no-cache vim bash curl wget

# --- 最终运行阶段 ---
FROM nginx:1.27-alpine3.22

COPY --from=base /etc/apk/repositories /etc/apk/repositories

# 从 builder 阶段复制版本文件和工具（如果需要）
COPY --from=builder /tmp/nginx_version /tmp/nginx_version
COPY --from=builder /usr/bin/vim /usr/bin/vim  # 示例：如果需要复制工具
COPY --from=builder /bin/bash /bin/bash
COPY --from=builder /usr/bin/curl /usr/bin/curl
COPY --from=builder /usr/bin/wget /usr/bin/wget

COPY ./configs/nginx/nginx.conf /etc/nginx/nginx.conf
COPY ./configs/nginx/conf.d /etc/nginx/conf.d

RUN chown -R nginx:nginx /var/cache/nginx /var/log/nginx

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**重要更新说明**：
- **基础镜像更新**：使用 `nginx:1.27-alpine3.22`，支持最新稳定 Nginx 系列。
- **Alpine 源版本**：统一为 `v3.22`。
- **动态版本提取**：提取实际版本（e.g., 1.27.2）到 `/tmp/nginx_version`。
- **共享 base**：从 base 阶段复制源配置。
- **多阶段优化**：添加 builder 和 final 阶段，分离安装工具以保持最终镜像轻量（仅复制必要的工具）。
- **ARG 参数支持**：添加 ARG BASE_IMAGE 参数，支持在 GitHub Actions 环境中使用本地构建的 base 镜像，同时提供默认值作为回退。

**文件: `wordpress-project/configs/nginx/nginx.conf`**

```nginx
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;

    include /etc/nginx/conf.d/*.conf;
}
```

**文件: `wordpress-project/configs/nginx/conf.d/default.conf`**

```nginx
server {
    listen 80;
    server_name localhost;

    root /var/www/html;
    index index.php index.html index.htm;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_pass wp:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

---

**本部分结束**。这是指南的第六部分（步骤四：构建自定义 Nginx 镜像）。我已修正Nginx Dockerfile，添加多阶段构建以优化（原文档中缺少final阶段）。由于日期为2025-10-12，且工具未检索到新hash，我保持PHP部分的hash不变。